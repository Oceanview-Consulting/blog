<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Oceanview Consulting &#8211; Helping developers and businesses identify and fulfill their software leadership
        potential</title>
    <link rel="alternate" type="application/rss+xml" title="Oceanview Consulting &raquo; Feed"
          href='http://localhost:4000/feed/'/>
    <link rel="alternate" type="application/rss+xml" title="Oceanview Consulting &raquo; Comments Feed"
          href='http://localhost:4000/comments/feed/'/>
    <link rel='stylesheet' id='escutcheon-style-css'
          href='http://localhost:4000/assets/css/style.css'
          type='text/css' media='all'/>
    <link rel='stylesheet' id='custom-css'
          href='http://localhost:4000/assets/css/custom.css'
          type='text/css' media='all'/>
    <link rel='stylesheet' id='escutcheon-fonts-css'
          href='http://localhost:4000/assets/css/fonts.css'
          type='text/css' media='all'/>
    <link rel='stylesheet' id='highlighter-css'
          href='http://localhost:4000/assets/css/pygment/native.css'
          type='text/css' media='all'/>
    <link rel='stylesheet' id='share-bar-css'
          href='http://localhost:4000/assets/css/share-bar.css'
          type='text/css' media='all'/>
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/socicon-fonts.css">

    <!-- Open Graph Tags -->
    <meta property="og:type" content="website"/>
    <meta property="og:title" content="Oceanview Consulting"/>
    <meta property="og:description"
          content="Helping developers and businesses identify and fulfill their software leadership potential"/>
    <meta property="og:url" content="https://ovitconsulting.com/"/>
    <meta property="og:site_name" content="Oceanview Consulting"/>
    <meta property="og:image"
          content='http://localhost:4000/assets/images/logo_darkbg_transparent.png?fit=3351,879&amp%3Bssl=1'
    <meta property="og:image:width" content="3351"/>
    <meta property="og:image:height" content="879"/>
    <meta property="og:locale" content="en_US"/>
    <meta name="twitter:site" content="@sysgineer"/>
</head>

<body class="home blog logged-in admin-bar no-customize-support has-site-logo">
<div id="page" class="hfeed site">
    <a class="skip-link screen-reader-text" href="#content">Skip to content</a>

    <header id="masthead" class="site-header" role="banner">
        <div class="navigation-wrapper">
            <nav id="site-navigation" class="main-navigation" role="navigation">
                <button class="menu-toggle" aria-controls="primary-menu" aria-expanded="false">Menu</button>
                <div class="menu-primary-container">
                    <ul id="menu-primary" class="menu">
                        <li id="menu-item-6"
                            class="menu-item menu-item-type-custom menu-item-object-custom current-menu-item current_page_item menu-item-6">
                            <a href="/">Home</a></li>
                        <li id="menu-item-48"
                            class="menu-item menu-item-type-post_type menu-item-object-page menu-item-48"><a
                                href="http://localhost:4000/presentations.html">Past Presentations</a></li>
                        <li id="menu-item-7"
                            class="menu-item menu-item-type-post_type menu-item-object-page menu-item-7"><a
                                href="http://localhost:4000/about">About Travis</a></li>
                    </ul>
                </div>
            </nav><!-- #site-navigation -->
        </div>

        <div class="site-branding">
            <a href="http://localhost:4000" class="site-logo-link" rel="home" itemprop="url"><img width="200"
                                                                                                        height="52"
                                                                                                        src="http://localhost:4000/assets/images/logo_darkbg_transparent.png"
                                                                                                        class="site-logo attachment-escutcheon-logo"
                                                                                                        alt=""
                                                                                                        data-size="escutcheon-logo"
                                                                                                        itemprop="logo"
                                                                                                        data-attachment-id="16"
                                                                                                        data-permalink="http://localhost:4000/assets/images/logo_darkbg_transparent.png"
                                                                                                        data-orig-file="http://localhost:4000/assets/images/logo_darkbg_transparent.png"
                                                                                                        data-orig-size="3351,879"
                                                                                                        data-image-title="logo_darkbg_transparent"
                                                                                                        /></a>
            <h1 class="site-title"><a href="http://localhost:4000" rel="home">Oceanview Consulting</a></h1>
            <h2 class="site-description">Helping developers and businesses identify and fulfill their software
                leadership potential</h2>
        </div><!-- .site-branding -->

    </header><!-- #masthead -->

    <div id="content" class="site-content">
        <div id="primary" class="content-area">
            <main id="main" class="site-main" role="main">
                <!-- TODO: Figure out how to handle per post head info
<head>

    <link rel='prev' title='“Programmer” is the New “Author”: How Misperception is Polluting an Industry'
          href='https://ovitconsulting.com/2018/07/14/programmer-is-the-new-author-how-misperception-is-polluting-an-industry/'/>

    <link rel="canonical"
          href="https://ovitconsulting.com/2018/07/18/tracking-asynchronous-process-completion-with-azure-application-insights/"/>
    <link rel='shortlink' href='https://wp.me/pa4Qes-1z'/>

    <meta property="og:type" content="article"/>
    <meta property="og:title" content="Tracking Asynchronous Process Completion with Azure Application Insights"/>
    <meta property="og:url"
          content="https://ovitconsulting.com/2018/07/18/tracking-asynchronous-process-completion-with-azure-application-insights/"/>
    <meta property="og:description"
          content="Recently I was working with a client that had developed several Azure based micro-services intended to run as an HTTP triggered process, running asynchronously from the client&#8217;s perspective. …"/>
    <meta property="article:published_time" content="2018-07-18T12:54:49+00:00"/>
    <meta property="article:modified_time" content="2018-07-18T13:11:35+00:00"/>
</head>
-->

<!-- Figure out how to inject single/single-post/post-template-default into body -->
<div class="single">
    <article id="post-97"
             class="post-97 post type-post status-publish format-standard hentry category-how-to tag-appinsights tag-azure tag-c">

        <header class="entry-header">
            <div class="entry-meta">
            <span class="byline">
                Written by <span class="author vcard"><a class="url fn n" href="http://localhost:4000/about">Travis Stokes</a></span>
            </span>
            <span class="posted-on">
                <a href="/how-to/2018/07/18/tracking-asynchronous-process-completion-with-azure-application-insights.html" rel="bookmark">
                    <time class="entry-date published" datetime="2018-07-18T08:54:49-04:00">Jul 18th, 2018</time>
                </a>
            </span>
            </div><!-- .entry-meta -->
            <h1 class="entry-title">Tracking Asynchronous Process Completion with Azure Application Insights</h1>
        </header>
        <!-- .entry-header -->

        <div class="entry-wrapper">
            <div class="entry-content">
                <p>Recently I was working with a client that had developed several Azure based micro-services intended to run as an HTTP
    triggered process, running asynchronously from the client's perspective. In other words, each pass through the
    system started with an HTTP request, for which the payload was then passed through a series of micro-services
    utilizing a combination of service buses and storage queues. It looks something like this:</p>
<p><img class="alignnone size-full wp-image-98" src="http://localhost:4000/assets/post_assets/async-process.png"
        alt="Async Process" width="960" height="560"/></p>
<p>The details are not terribly important - just note that each of the blue boxes in this diagram represents a separate
    Azure hosted ASP.NET WebAPI or Azure Function based micro-service. Because these were all separate components
    communicating via service bus and storage queues, plus one black box 3rd party system, message loss and round trip
    request duration was difficult to track and build into an easily consumable dashboard.</p>
<p>To address this problem, a solution was developed utilizing a combination of custom telemetry events logged by each
    system component and Application Insights queries .</p>
<!--more-->
<h4>Creating Telemetry Events</h4>
<p>Let's start with the telemetry events. The goal here is to provide Application Insights with events at each step in
    the system, tagged with a request identifier value. The TelemetryClient included in the Application Insights package
    published by Microsoft makes this pretty easy.</p>
<p>First, add the <code class="EnlighterJSRAW" data-enlighter-language="shell">Microsoft.ApplicationInsights</code>
    NuGet package to the project you want to track events from. You can do this either via the Manage Nuget Packages
    interface, or via the Package Console using <code class="EnlighterJSRAW" data-enlighter-language="shell">Install-Package
        Microsoft.ApplicationInsights</code>.</p>
<p>Next, we need to create a telemetry client. To do this, we need an instrumentation key, which Application Insights
    utilizes to route telemetry to the correct instance. In this case, we are relying on the <em>APPINSIGHTS_INSTRUMENTATIONKEY</em>
    app setting, which gets set automatically by azure when you enable Application Insights for a function application.
</p>
<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">Microsoft.ApplicationInsights</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.ApplicationInsights.Extensibility</span><span class="p">;</span>

<span class="n">TelemetryClient</span> <span class="n">telemetryClient</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">TelemetryClient</span><span class="p">(</span>
    <span class="k">new</span> <span class="n">TelemetryConfiguration</span>
    <span class="p">{</span>
        <span class="n">InstrumentationKey</span> <span class="p">=</span> <span class="n">ConfigurationManager</span><span class="p">.</span><span class="n">AppSettings</span><span class="p">[</span><span class="s">"APPINSIGHTS_INSTRUMENTATIONKEY"</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">);</span></code></pre></figure>
<p>Finally, we can add the telemetry event by creating a TelemetryEvent object and using our client to track it. The
    trick here is to set the context operation_Id to a value that each component in our system will have access to, so
    that we can correlate the events on that value.</p>
<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">trackingEvent</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">EventTelemetry</span><span class="p">(</span><span class="s">"Intake"</span><span class="p">);</span>
<span class="n">trackingEvent</span><span class="p">.</span><span class="n">Context</span><span class="p">.</span><span class="n">Operation</span><span class="p">.</span><span class="n">Id</span> <span class="p">=</span> <span class="n">requestId</span><span class="p">;</span>
<span class="n">_telemetryClient</span><span class="p">.</span><span class="nf">TrackEvent</span><span class="p">(</span><span class="n">trackingEvent</span><span class="p">);</span></code></pre></figure>
<p>The same two code segments can be used in each component in the system. At a minimum, to track request completion,
    events will need to be added for the initial intake component (typically an API or HTTP triggered Azure function)
    and the final component in the system (typically a response notification method). The only thing that needs to
    change is the "EventName" string, which should be unique for each location you'd like to track.</p>
<h4>Reporting</h4>
<p>With telemetry events being provided to Application Insights, we have the data we need to track the two metrics we
    care about:</p>
<ol>
    <li>How long it takes a request to make it from intake through the final component of the system (<strong>Request
        Duration</strong>).
    </li>
    <li>How many, if any, requests fail to make it all the way through the system (<strong>Failed Requests</strong>).
    </li>
</ol>
<p>The first step for both of these metrics is to generate a list of requests taken in (with a corresponding timestamp),
    joined together (by operation id) with the corresponding final step events. For our purposes, we will assume the
    relevant events are named "Intake" and "Complete".</p>
<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="o">//</span> <span class="n">Capture</span> <span class="k">some</span> <span class="n">variables</span><span class="p">;</span> <span class="n">this</span> <span class="k">is</span> <span class="n">primarily</span> <span class="k">to</span> <span class="n">aid</span> <span class="n">re</span><span class="o">-</span><span class="n">use</span> <span class="o">/</span> <span class="n">configuration</span>
<span class="n">let</span> <span class="n">startEvent</span> <span class="o">=</span> <span class="nv">"Intake"</span><span class="p">;</span>
<span class="n">let</span> <span class="n">completeEvent</span> <span class="o">=</span> <span class="nv">"Complete"</span><span class="p">;</span>
<span class="n">let</span> <span class="n">eventsData</span> <span class="o">=</span> <span class="n">customEvents</span><span class="p">;</span> <span class="o">//</span> <span class="n">This</span> <span class="n">can</span> <span class="n">be</span> <span class="n">used</span> <span class="k">to</span> <span class="n">enable</span> <span class="k">cross</span> <span class="n">AI</span> <span class="n">instance</span> <span class="n">reporting</span><span class="p">.</span>
<span class="n">let</span> <span class="n">granularity</span> <span class="o">=</span> <span class="n">time</span><span class="p">(</span><span class="mi">1</span><span class="n">m</span><span class="p">);</span>
<span class="n">let</span> <span class="n">rangeStart</span> <span class="o">=</span> <span class="n">bin</span><span class="p">(</span><span class="n">ago</span><span class="p">(</span><span class="mi">24</span><span class="n">h</span><span class="p">),</span> <span class="n">granularity</span><span class="p">);</span>
<span class="n">let</span> <span class="n">rangeEnd</span> <span class="o">=</span> <span class="n">bin</span><span class="p">(</span><span class="n">now</span><span class="p">(),</span> <span class="n">granularity</span><span class="p">);</span>
<span class="n">eventsData</span>
<span class="o">|</span> <span class="k">where</span> <span class="n">name</span> <span class="o">==</span> <span class="n">startEvent</span> <span class="k">and</span> <span class="k">timestamp</span> <span class="k">between</span> <span class="p">(</span><span class="n">rangeStart</span><span class="p">..</span><span class="n">rangeEnd</span><span class="p">)</span>
<span class="o">|</span> <span class="n">project</span> <span class="k">start</span> <span class="o">=</span> <span class="k">timestamp</span><span class="p">,</span> <span class="n">operation_Id</span>
<span class="o">|</span> <span class="k">join</span> <span class="n">kind</span><span class="o">=</span><span class="n">leftouter</span>
<span class="p">(</span>
    <span class="n">eventsData</span>
    <span class="o">|</span> <span class="k">where</span> <span class="n">name</span> <span class="o">==</span> <span class="n">completeEvent</span>
    <span class="o">|</span> <span class="n">project</span> <span class="n">complete</span> <span class="o">=</span> <span class="k">timestamp</span><span class="p">,</span> <span class="n">operation_Id</span>
<span class="p">)</span>
<span class="k">on</span> <span class="n">operation_Id</span></code></pre></figure>
<p>Most of this should be pretty straightforward if you've played around with Application Insights before. The one thing
    worth calling out is the use of the eventsData variable. Because Azure apps are frequently split across regions, and
    Application Insights instances can be included in that split, it is sometimes useful to query multiple instances. To
    do this, you can union multiple customEvents tables like so*:</p>
<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="n">let</span> <span class="n">eventsData</span> <span class="o">=</span> <span class="n">app</span><span class="p">(</span><span class="s1">'east-ai-instance'</span><span class="p">).</span><span class="n">customEvents</span> <span class="o">|</span> <span class="k">union</span> <span class="n">app</span><span class="p">(</span><span class="s1">'west-ai-instance'</span><span class="p">).</span><span class="n">customEvents</span></code></pre></figure>
<p>The end result of this query is a table with four columns:</p>
<p><img class="alignnone size-full wp-image-139" src="http://localhost:4000/assets/post_assets/base_events-1.png" alt=""
        width="905" height="186"/></p>
<p>Using this data set as a base, we can filter and project the events into the two data points we care about.</p>
<h5>Duration</h5>
<p>Producing the duration dataset requires minimal changes to the base query; simply add two clauses:</p>
<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="o">|</span> <span class="k">where</span> <span class="k">isnull</span><span class="p">(</span><span class="n">complete</span><span class="p">)</span> <span class="o">==</span> <span class="k">false</span>
<span class="o">|</span> <span class="n">project</span> <span class="k">start</span><span class="p">,</span> <span class="n">duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">complete</span> <span class="o">-</span> <span class="k">start</span><span class="p">)</span><span class="o">/</span><span class="n">time</span><span class="p">(</span><span class="mi">1</span><span class="n">s</span><span class="p">)</span></code></pre></figure>

<div>By using the where clause to filter out the records with no completion, we ensure we are only retrieving completed
    requests. Following that by projecting the start timestamp and a quick calculation of the duration gives us our
    final table with two columns: start and duration. With that data, we can create a chart of the requests and their
    duration.
</div>
<div></div>
<div><img class="alignnone size-full wp-image-145" src="http://localhost:4000/assets/post_assets/durchart.png" alt=""
          width="1582" height="567"/></div>
<div></div>
<h5>Failed Requests</h5>
<p>Producing the failed request data set is even easier, because we don't have to do any calculations in the projection.
    Simply filter out the records with completion events (and those started within the last 5 minutes) and project the
    start and operation_Id as follows:</p>
<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="o">|</span> <span class="k">where</span> <span class="k">isnull</span><span class="p">(</span><span class="n">complete</span><span class="p">)</span> <span class="k">and</span> <span class="k">start</span> <span class="o">&lt;</span> <span class="n">ago</span><span class="p">(</span><span class="mi">5</span><span class="n">m</span><span class="p">)</span>
<span class="o">|</span> <span class="n">project</span> <span class="k">start</span><span class="p">,</span> <span class="n">operation_Id</span></code></pre></figure>
<p>With those additions, we can generate a table of failed requests, with corresponding request IDs.</p>
<p><img class="alignnone size-full wp-image-146" src="http://localhost:4000/assets/post_assets/failreq.png" alt=""
        width="435" height="156"/></p>
<p>There is an advanced version of this that can be turned into a chart for dashboards as well. If you'd like to learn
    more about that, or about custom charts on dashboards in general, check back soon as I'll be covering that topic
    next  -or just following me on <a href="https://twitter.com/sysgineer">Twitter @sysgineer</a> to be notified of all
    my upcoming articles. In the mean time, feel free to <a
            href="https://github.com/Oceanview-Consulting/CustomTelemetrySample">pull down the example app</a> and let
    me know if you have questions!</p>
<p><sub>* For more information, see <a href="https://azure.microsoft.com/en-us/blog/query-across-resources/"
                                       target="_blank" rel="noopener">this article from Microsoft</a>.</sub></p>

                <div id="share-bar">
    <h4>Did you find this useful? Pass it on!</h4>
    <div class="share-buttons">
        <a  href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/how-to/2018/07/18/tracking-asynchronous-process-completion-with-azure-application-insights.html"
            onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
            title="Share on Facebook" >
            <i class="socicon-facebook share-button"> </i>
        </a>

        <a  href="https://twitter.com/intent/tweet?text=Tracking Asynchronous Process Completion with Azure Application Insights&url=http://localhost:4000/how-to/2018/07/18/tracking-asynchronous-process-completion-with-azure-application-insights.html"
            onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
            title="Share on Twitter" >
            <i class="socicon-twitter share-button"> </i>
        </a>

        <a  href="https://plus.google.com/share?url=http://localhost:4000/how-to/2018/07/18/tracking-asynchronous-process-completion-with-azure-application-insights.html"
            onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
            title="Share on Google+" >
            <i class="socicon-googleplus share-button"> </i>
        </a>

        <a  href="http://www.reddit.com/submit?url=http://localhost:4000/how-to/2018/07/18/tracking-asynchronous-process-completion-with-azure-application-insights.html"
            onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;"
            title="Share on Reddit" >
            <i class="socicon-reddit share-button"> </i>
        </a>

        <a  href="https://www.linkedin.com/shareArticle?mini=true&url=http://localhost:4000/how-to/2018/07/18/tracking-asynchronous-process-completion-with-azure-application-insights.html&title=Tracking Asynchronous Process Completion with Azure Application Insights&summary=&source="
            onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
            title="Share on LinkedIn" >
            <i class="socicon-linkedin share-button"> </i>
        </a>

        <a  href="mailto:?subject=Tracking Asynchronous Process Completion with Azure Application Insights&amp;body=Check out this site http://localhost:4000/how-to/2018/07/18/tracking-asynchronous-process-completion-with-azure-application-insights.html"
            title="Share via Email" >
            <i class="fa fa-envelope share-button"> </i>
        </a>
    </div>
</div>
            </div><!-- .entry-content -->
            <!-- TODO: Add footer with tags/categories
            <footer class="entry-footer">
                    <span class="cat-links">Posted in <a href="https://ovitconsulting.com/category/how-to/"
                                                         rel="category tag">How-To</a>.</span><span
                    class="tags-links">Tagged <a href="https://ovitconsulting.com/tag/appinsights/"
                                                 rel="tag">appinsights</a>, <a
                    href="https://ovitconsulting.com/tag/azure/"
                    rel="tag">azure</a>, <a
                    href="https://ovitconsulting.com/tag/c/" rel="tag">c#</a>.</span><span class="edit-link"><a
                    class="post-edit-link" href="https://wordpress.com/post/ovitconsulting.com/97">Edit</a></span>
            </footer>
            -->
            <!-- .entry-footer -->
        </div>
    </article><!-- #post-## -->
</div>
            </main><!-- #main -->
        </div><!-- #primary -->
    </div><!-- #content -->
    <footer id="colophon" class="site-footer" role="contentinfo">
        <div class="site-info">
            Copyright 2018 Oceanview Consulting, LLC
        </div><!-- .site-info -->
    </footer><!-- #colophon -->
</div><!-- #page -->
</body>
</html>
